/*S_BUSCOMP TABLE Creation*/
CREATE TABLE S_BUSCOMP(
ROW_ID VARCHAR2(10) CONSTRAINT S_BUSCOMP_ID_PK PRIMARY KEY,
NAME VARCHAR2(30),
SRCHSPEC VARCHAR2(30));


ALTER TABLE S_BUSCOMP
ADD TABLE_NAME VARCHAR2(30) CONSTRAINT S_BUSCOMP_TN_NN NOT NULL;

/*1 BC RECORD*/
INSERT INTO S_BUSCOMP
VALUES('100BC','Account','[Id] <> null','S_ORG_EXT');

INSERT INTO S_BUSCOMP
VALUES('101BC','Account-Simple','[Id] <> null','S_ORG_EXT');

INSERT INTO S_BUSCOMP
VALUES('102BC','Account-Light','[Id] <> null','S_ORG_EXT');

INSERT INTO S_BUSCOMP
VALUES('103BC','Account-Heavy','[Id] <> null','S_ORG_EXT');

/*S_FIELD Table Creation*/
CREATE TABLE S_FIELD(
ROW_ID VARCHAR2(10) CONSTRAINT S_FIELD_ID_PK PRIMARY KEY,
NAME VARCHAR2(30),
BUSCOMP_ID VARCHAR(10) CONSTRAINT S_FIELD_BC_ID_NN NOT NULL,
COLUMN_NAME VARCHAR(20) CONSTRAINT S_FIELD_COLUMN_NN NOT NULL,
JOIN_NAME VARCHAR(20),
LINK_NAME VARCHAR(20),
FORCEACTIVE CHAR(1));

/*Account-Simple BC*/
INSERT INTO S_FIELD
VALUES('100F1','FIELD1_1','101BC','COLUMN1','-','-','Y');
INSERT INTO S_FIELD
VALUES('102F1','FIELD2_1','101BC','COLUMN2','-','LINK2','N');
INSERT INTO S_FIELD
VALUES('103F1','FIELD3_1','101BC','COLUMN3','-','-','N');
INSERT INTO S_FIELD
VALUES('104F1','FIELD4_1','101BC','COLUMN4','JOIN4','-','N');
INSERT INTO S_FIELD
VALUES('105F1','FIELD5_1','101BC','COLUMN5','-','LINK5','Y');
INSERT INTO S_FIELD
VALUES('106F1','FIELD6_1','101BC','COLUMN6','-','LINK6','N');
INSERT INTO S_FIELD
VALUES('107F1','FIELD7_1','101BC','COLUMN7','-','-','Y');
INSERT INTO S_FIELD
VALUES('108F1','FIELD8_1','101BC','COLUMN8','JOIN8','-','N');
INSERT INTO S_FIELD
VALUES('109F1','FIELD9_1','101BC','COLUMN9','-','-','Y');
INSERT INTO S_FIELD
VALUES('110F1','FIELD10_1','101BC','COLUMN10','JOIN10','-','N');
INSERT INTO S_FIELD
VALUES('111F1','FIELD11_1','101BC','COLUMN11','-','LINK11','N');


/*Account-LIGHT BC*/
INSERT INTO S_FIELD
VALUES('100F2','FIELD1_2','102BC','COLUMN1','-','LINK1','Y');
INSERT INTO S_FIELD
VALUES('102F2','FIELD2_2','102BC','COLUMN2','-','_','Y');
INSERT INTO S_FIELD
VALUES('103F2','FIELD3_2','102BC','COLUMN3','JOIN3','LINK3','N');
INSERT INTO S_FIELD
VALUES('104F2','FIELD4_2','102BC','COLUMN4','-','-','Y');
INSERT INTO S_FIELD
VALUES('105F2','FIELD5_2','102BC','COLUMN5','-','LINK5','Y');
INSERT INTO S_FIELD
VALUES('106F2','FIELD6_2','102BC','COLUMN6','-','LINK6','Y');
INSERT INTO S_FIELD
VALUES('107F2','FIELD7_2','102BC','COLUMN7','-','-','Y');
INSERT INTO S_FIELD
VALUES('108F2','FIELD8_2','102BC','COLUMN8','-','LINK8','Y');
INSERT INTO S_FIELD
VALUES('109F2','FIELD9_2','102BC','COLUMN9','-','-','Y');
INSERT INTO S_FIELD
VALUES('110F2','FIELD10_2','102BC','COLUMN10','-','-','Y');
INSERT INTO S_FIELD
VALUES('111F2','FIELD11_2','102BC','COLUMN11','-','LINK11','Y');

/*Account-HEAVY BC*/
INSERT INTO S_FIELD
VALUES('100F3','FIELD1_3','103BC','COLUMN1','-','LINK1','Y');
INSERT INTO S_FIELD
VALUES('102F3','FIELD2_3','103BC','COLUMN2','-','LINK2','Y');
INSERT INTO S_FIELD
VALUES('103F3','FIELD3_3','103BC','COLUMN3','-','LINK3','Y');
INSERT INTO S_FIELD
VALUES('104F3','FIELD4_3','103BC','COLUMN4','JOIN4','-','Y');
INSERT INTO S_FIELD
VALUES('105F3','FIELD5_3','103BC','COLUMN5','-','LINK5','Y');
INSERT INTO S_FIELD
VALUES('106F3','FIELD6_3','103BC','COLUMN6','-','LINK6','Y');
INSERT INTO S_FIELD
VALUES('107F3','FIELD7_3','103BC','COLUMN7','-','LINK7','Y');
INSERT INTO S_FIELD
VALUES('108F3','FIELD8_3','103BC','COLUMN8','JOIN8','-','Y');
INSERT INTO S_FIELD
VALUES('109F3','FIELD9_3','103BC','COLUMN9','-','LINK9','Y');
INSERT INTO S_FIELD
VALUES('110F3','FIELD10_3','103BC','COLUMN10','JOIN10','-','Y');
INSERT INTO S_FIELD
VALUES('111F3','FIELD11_3','103BC','COLUMN11','-','LINK11','Y');
INSERT INTO S_FIELD
VALUES('112F3','FIELD12_3','103BC','COLUMN12','-','LINK11','Y');

/*Account BC*/
INSERT INTO S_FIELD
VALUES('100F','FIELD1','100BC','COLUMN1','JOIN1','LINK1','Y');
INSERT INTO S_FIELD
VALUES('102F','FIELD2','100BC','COLUMN2','JOIN2','LINK2','N');
INSERT INTO S_FIELD
VALUES('103F','FIELD3','100BC','COLUMN3','JOIN3','LINK3','N');
INSERT INTO S_FIELD
VALUES('104F','FIELD4','100BC','COLUMN4','JOIN4','-','N');
INSERT INTO S_FIELD
VALUES('105F','FIELD5','100BC','COLUMN5','-','LINK5','Y');
INSERT INTO S_FIELD
VALUES('106F','FIELD6','100BC','COLUMN6','-','LINK6','Y');
INSERT INTO S_FIELD
VALUES('107F','FIELD7','100BC','COLUMN7','-','-','Y');
INSERT INTO S_FIELD
VALUES('108F','FIELD8','100BC','COLUMN8','JOIN8','-','Y');
INSERT INTO S_FIELD
VALUES('109F','FIELD9','100BC','COLUMN9','-','-','Y');
INSERT INTO S_FIELD
VALUES('110F','FIELD10','100BC','COLUMN10','JOIN10','-','Y');
INSERT INTO S_FIELD
VALUES('111F','FIELD11','100BC','COLUMN11','-','LINK11','Y');



SELECT field.*, bc.NAME FROM S_FIELD field, S_BUSCOMP bc
WHERE field.BUSCOMP_ID = bc.ROW_ID
AND field.FORCEACTIVE = 'Y'
AND field.COLUMN_NAME = 'COLUMN10'
ORDER BY BC.NAME;


SELECT DISTINCT BUSCOMP_ID FROM S_FIELD fout
WHERE fout.BUSCOMP_ID IN (
SELECT fin.BUSCOMP_ID FROM S_FIELD fin
WHERE fin.COLUMN_NAME = 'COLUMN12')
GROUP BY COLUMN_NAME, BUSCOMP_ID
HAVING COLUMN_NAME IN ('COLUMN10','COLUMN7','COLUMN12','col');


SELECT COLUMN_NAME, COUNT(COLUMN_NAME) FROM S_FIELD
GROUP BY COLUMN_NAME
HAVING COLUMN_NAME IN ('COLUMN10','COLUMN7','COLUMN12')
    --AND COUNT(COLUMN_NAME) = 1
ORDER BY COLUMN_NAME;

/* This may work*/
SELECT fout.BUSCOMP_ID, COUNT(fout.BUSCOMP_ID) FROM S_FIELD fout
WHERE fout.BUSCOMP_ID IN (
    SELECT fin.BUSCOMP_ID FROM S_FIELD fin
    WHERE fin.COLUMN_NAME IN ('COLUMN10','COLUMN3','COLUMN4')
    GROUP BY fin.BUSCOMP_ID
    HAVING COUNT(fin.BUSCOMP_ID) = 3)
AND fout.FORCEACTIVE = 'Y'
GROUP BY fout.BUSCOMP_ID
ORDER BY COUNT(fout.BUSCOMP_ID);

SELECT BUSCOMP_ID FROM S_FIELD fout
WHERE  (fout.COLUMN_NAME  = ALL ('COLUMN10','COLUMN3','COLUMN12'))
GROUP BY BUSCOMP_ID;


/*START: IT WORKED*/
WITH TEMP_BC(ID) AS (
    SELECT fin.BUSCOMP_ID FROM S_FIELD fin
    WHERE fin.COLUMN_NAME IN ('COLUMN10','COLUMN3','COLUMN12')
    GROUP BY fin.BUSCOMP_ID
    HAVING COUNT(fin.BUSCOMP_ID) = 3
)
SELECT BC.ROW_ID, BC.NAME, BC.TABLE_NAME, LI.LI_COUNT, JO.JO_COUNT, FA.FA_COUNT FROM S_BUSCOMP BC, 
(SELECT faf.BUSCOMP_ID AS BC_ID, COUNT(faf.BUSCOMP_ID) AS FA_COUNT FROM TEMP_BC temp, S_FIELD faf
    WHERE faf.BUSCOMP_ID = temp.ID
    AND faf.FORCEACTIVE = 'Y'
    GROUP BY faf.BUSCOMP_ID
) FA, 
(SELECT faf.BUSCOMP_ID AS BC_ID, COUNT(faf.BUSCOMP_ID) AS JO_COUNT FROM TEMP_BC temp, S_FIELD faf
    WHERE faf.BUSCOMP_ID = temp.ID
    AND faf.FORCEACTIVE = 'Y'
    AND faf.JOIN_NAME NOT IN ('-','_')
    GROUP BY faf.BUSCOMP_ID
) JO,
(SELECT faf.BUSCOMP_ID AS BC_ID, COUNT(faf.BUSCOMP_ID) AS LI_COUNT FROM TEMP_BC temp, S_FIELD faf
    WHERE faf.BUSCOMP_ID = temp.ID
    AND faf.FORCEACTIVE = 'Y'
    AND faf.LINK_NAME NOT IN ('-','_')
    GROUP BY faf.BUSCOMP_ID
) LI
WHERE FA.BC_ID = JO.BC_ID (+)
    AND FA.BC_ID = LI.BC_ID (+)
    AND BC.ROW_ID = FA.BC_ID
ORDER BY LI.LI_COUNT, JO.JO_COUNT, FA.FA_COUNT;
/*END: IT WORKED*/

SELECT * FROM S_FIELD
WHERE BUSCOMP_ID = '103BC'
AND LINK_NAME = '_'

WITH employee AS (SELECT * FROM HR.Employees)
SELECT * FROM employee WHERE ID > 20
UNION ALL
SELECT * FROM employee WHERE Sex = 'M'
